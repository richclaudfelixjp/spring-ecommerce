# ecommerceプロジェクト用のGitHub Actions CDワークフロー

name: Ecommerce CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Build with Maven # Mavenでビルド
      run: mvn -B package --file pom.xml

    - name: Configure AWS Credentials # AWS認証情報の設定
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-s3-role
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Upload artifact to S3 # S3にアーティファクトをアップロード
      run: aws s3 cp target/*.jar s3://${{ secrets.S3_BUCKET_NAME }}/spring-ecommerce.jar

    - name: Deploy to EC2 # EC2へのデプロイ
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          # Set environment variables
          export DB_URL=jdbc:postgresql://${{ secrets.RDS_ENDPOINT }}:5432/ecommercedb
          export DB_USERNAME=${{ secrets.RDS_USERNAME }}
          export DB_PASSWORD=${{ secrets.RDS_PASSWORD }}
          export STRIPE_API_KEY=${{ secrets.STRIPE_API_KEY_SECRET }}
          export JWT_SECRET=${{ secrets.JWT_SECRET }}
          export JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}
          export ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          export USER_PASSWORD=${{ secrets.USER_PASSWORD }}

          # Download new artifact from S3
          aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/spring-ecommerce.jar /home/${{ secrets.EC2_USERNAME }}/spring-ecommerce.jar

          # Restart the service
          # The service manager (systemd) will handle stopping the old process and starting the new one.
          sudo systemctl restart spring-ecommerce.service