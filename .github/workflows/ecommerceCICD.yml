# ecommerceプロジェクト用のGitHub Actions CDワークフロー

name: Ecommerce CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Build with Maven # Mavenでビルド
      run: mvn -B package --file pom.xml

    - name: Configure AWS Credentials # AWS認証情報の設定
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-s3-role
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Upload artifact to S3 # S3にアーティファクトをアップロード
      run: aws s3 cp target/*.jar s3://${{ secrets.S3_BUCKET_NAME }}/spring-ecommerce.jar

    - name: Deploy to EC2 # EC2へのデプロイ
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
         # Create or overwrite the environment file with secrets in Spring Boot's format
          echo "SPRING_DATASOURCE_URL=jdbc:postgresql://${{ secrets.RDS_ENDPOINT }}:5432/ecommercedb" | sudo tee /etc/environment
          echo "SPRING_DATASOURCE_USERNAME=${{ secrets.RDS_USERNAME }}" | sudo tee -a /etc/environment
          echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.RDS_PASSWORD }}" | sudo tee -a /etc/environment
          echo "STRIPE_API_KEY_SECRET=${{ secrets.STRIPE_API_KEY_SECRET }}" | sudo tee -a /etc/environment
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" | sudo tee -a /etc/environment
          echo "JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}" | sudo tee -a /etc/environment
          echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" | sudo tee -a /etc/environment
          echo "USER_PASSWORD=${{ secrets.USER_PASSWORD }}" | sudo tee -a /etc/environment
          
          # Also add the PostgreSQL dialect for good measure
          echo "SPRING_JPA_DATABASE-PLATFORM=org.hibernate.dialect.PostgreSQLDialect" | sudo tee -a /etc/environment

          # Download new artifact from S3
          aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/spring-ecommerce.jar /home/${{ secrets.EC2_USERNAME }}/spring-ecommerce.jar

          # Restart the service
          sudo systemctl restart spring-ecommerce.service